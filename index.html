<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Mount Zoom Status</title>

  <link rel="icon" href="eye-of-sauron.png">
  <link href="https://fonts.googleapis.com/css2?family=Uncial+Antiqua&display=swap" rel="stylesheet">

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />

  <style>
    body {
      margin: 0;
      font-family: 'Ringbearer', 'Uncial Antiqua', serif;
      background: url('middle-earth-bg.jpg') center/cover no-repeat;
      color: #e4c35a;
      min-height: 100vh;
      position: relative;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.65);
      z-index: 0;
    }

    .page {
      position: relative;
      z-index: 1;
      padding: 24px 16px 40px;
      max-width: 1200px;
      margin: 0 auto;
    }

    header {
      text-align: center;
      margin-bottom: 24px;
    }

    .eye {
      width: 90px;
      margin-bottom: 12px;
      animation: pulse 2s infinite;
    }

    h1 {
      font-size: 2.4rem;
      margin: 0 0 6px;
    }

    .subheading {
      font-size: 1.1rem;
      font-style: italic;
      opacity: 0.9;
    }

    /* --- Main layout --- */

    .status-layout {
      display: grid;
      grid-template-columns: 1.4fr 1fr;
      gap: 20px;
      align-items: start;
      margin-top: 26px;
    }

    @media (max-width: 900px) {
      .status-layout {
        grid-template-columns: 1fr;
      }
    }

    /* --- Image --- */

    .image-panel {
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .image-panel img {
      width: 100%;
      max-height: 70vh;
      object-fit: contain;
      border-radius: 10px;
      box-shadow: 0 0 30px rgba(0,0,0,0.8);
      background: rgba(0,0,0,0.3);
    }

    /* --- Info + map --- */

    .info-panel {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .last-seen-meta {
      font-size: 0.95rem;
      line-height: 1.5;
      opacity: 0.9;
    }

    .last-seen-meta span {
      display: block;
    }

    #map {
      height: 280px;
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 0 18px rgba(0,0,0,0.7);
    }

    /* --- Button --- */

    .actions {
      margin-top: 18px;
      text-align: center;
    }

    button {
      padding: 10px 26px;
      font-size: 1rem;
      background: #000;
      color: #e4c35a;
      border: 2px solid #e4c35a;
      border-radius: 8px;
      cursor: pointer;
    }

    footer {
      text-align: center;
      font-size: 0.75rem;
      opacity: 0.6;
      margin-top: 28px;
    }

    @keyframes pulse {
      0% { transform: scale(1); filter: drop-shadow(0 0 0 red); }
      50% { transform: scale(1.05); filter: drop-shadow(0 0 8px orange); }
      100% { transform: scale(1); filter: drop-shadow(0 0 0 red); }
    }
  </style>
</head>

<body>
  <div class="overlay"></div>

  <div class="page">
    <header>
      <img src="eye-of-sauron.png" class="eye" alt="">
      <h1>The Stream Has Gone Into Mordor</h1>
      <div class="subheading" id="subheading">Lighting the beacons...</div>
    </header>

    <div class="status-layout" id="status" style="display:none">
      <!-- Image -->
      <div class="image-panel">
        <img id="last-image" alt="Last known view">
      </div>

      <!-- Info + map -->
      <div class="info-panel">
        <div class="last-seen-meta">
          <span id="ls-location"></span>
          <span id="ls-age"></span>
          <span id="ls-time"></span>
          <span id="ls-coords"></span>
        </div>

        <div id="map"></div>
      </div>
    </div>

    <div class="actions">
      <button onclick="tryReconnect()">Try Again</button>
    </div>

    <footer>
      2025 G&J Co • The Eye sees all, eventually
    </footer>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const homepageURL = "https://mountzoom.hylton.co.nz";

    const messages = [
      "Lighting the beacons...",
      "Polishing axes...",
      "Rerouting through Fangorn...",
      "Asking Gandalf...",
      "Checking Helm’s Deep..."
    ];

    let i = 0;
    setInterval(() => {
      document.getElementById("subheading").textContent =
        messages[++i % messages.length];
    }, 3000);

    function tryReconnect() {
      fetch(homepageURL, { method: "HEAD", mode: "no-cors" })
        .then(() => location.href = homepageURL)
        .catch(() => {});
    }

    fetch("/api/last-seen", { cache: "no-store" })
      .then(r => r.ok ? r.json() : null)
      .then(data => {
        if (!data) return;

        document.getElementById("status").style.display = "grid";

        document.getElementById("last-image").src =
          `${data.imageUrl}?t=${Date.now()}`;

        document.getElementById("ls-location").textContent =
          `Last known sighting: ${data.locationLabel}`;

        document.getElementById("ls-age").textContent =
          `${data.ageMinutes} minutes ago`;

        document.getElementById("ls-time").textContent =
          `Timestamp: ${new Date(data.timestamp).toUTCString()}`;

        if (Number.isFinite(data.lat) && Number.isFinite(data.lon)) {
          document.getElementById("ls-coords").textContent =
            `Coordinates: ${data.lat.toFixed(5)}, ${data.lon.toFixed(5)}`;

          const map = L.map("map", {
            zoomControl: false,
            attributionControl: false,
            dragging: false,
            scrollWheelZoom: false
          }).setView([data.lat, data.lon], 11);

          L.tileLayer(
            "https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png",
            { maxZoom: 19 }
          ).addTo(map);

          L.marker([data.lat, data.lon]).addTo(map);
        } else {
          document.getElementById("map").style.display = "none";
        }
      });
  </script>
</body>
</html>
